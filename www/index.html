<!DOCTYPE HTML>
<html>
<head>

<style>
.long-textbox{
  width: 300px;
}
.login{
  background-color:#EEE;
}
</style>

<script src="js/vue.js"></script>
<script src="js/vue-resource.min.js"></script>

</head>
<body>
    <div class="login">
        Login with Cookies:
        <form action="/login/cookies" method="post">
          DedeUserID: <input type="text" name="DedeUserID" class="long-textbox"/><br>
          DedeUserID__ckMd5: <input type="password" name="DedeUserID__ckMd5" class="long-textbox"/><br>
          SESSDATA: <input type="password" name="SESSDATA" class="long-textbox"/><br>
          <input type="submit" value="Login" />
        </form>
    </div>
<div id="dynamic">
  Your blacklist:
  <div id="blacklist">
    <ol>
      <blacklist-item v-for="item in blacklist" :key="item.id" v-bind:item="item" v-on:refresh="refreshBlacklist"></blacklist-item>
    </ol>
  </div>

  Sharelist:
  <div id="sharelist">
    <ol>
      <share-item v-for="item in sharelist" :key="item._id" v-bind:item="item"></share-item>
    </ol>
  </div>
</div>
<form action="/add_item" method="post">
    type: <input type="text" name="type"/><br>
    filter: <input type="text" name="filter" class="long-textbox"/><br>
    <input type="submit" value="Add" />
</form>

<form action="/del_item" method="post">
    id: <input type="text" name="ids"/><br>
    <input type="submit" value="Del" />
</form>

<form action="/add_sharelist" method="post">
    name: <input type="text" name="name"/><br>
    description: <br>
    <textarea name="description" style="width:30%;height:100px"></textarea> <br>
    filters: <br>
    <textarea name="filters" style="width:30%;height:100px"></textarea>
    <input type="submit" value="Add" />
</form>
<script>
Vue.component('blacklist-item', {
  props: ['item'],
  methods: {
      removeItem: function(id){
          this.$http.post('/del_item', {"ids":id}).then(response => {
              this.$emit('refresh');
          },response => {
              console.log("Failed");
          });
      }
  },
  template: '<li>{{ ["Normal","Regex","User"][item.type] }} {{ item.filter }} <a href="javascript:void(0)" v-on:click="removeItem(item.id)">Del</a></li>'
});
Vue.component('share-item', {
  props: ['item'],
  template: '<li>{{item.name}} {{item.vote}} {{item.usage}} <a :href="\'view/\'+item._id">View</a> <a :href="\'apply/\'+item._id">Apply</a> <a :href="\'upvote/\'+item._id">Upvote</a></li>'
});

var app = new Vue({
  el: '#dynamic',
  data: {
    blacklist: [],
    sharelist: [],
    notLogin: document.cookie.indexOf('bilibili_cookies=')==-1,
  },
  methods: {
    refreshBlacklist: function(){
      this.$http.get('/fetch_blacklist').then(response => {
        if(response.body.code!=undefined){
          console.log("Failed to fetch blacklist: "+response.body.code);
          return;
        }
        sessionStorage.blacklist = response.body;
        this.blacklist = response.body;
      }, response => {
        console.log("Failed to fetch blacklist")
      });
    }
  },
  mounted: function() {
      this.refreshBlacklist();
      this.$http.get('/fetch_sharelist').then(response => {
        this.sharelist = response.body;
      }, response => {
        console.log("Failed to fetch sharelist");
      });
  }
});
</script>
</body>
</html>
